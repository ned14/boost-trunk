# Copyright 2006 Roland Schwarz.
# Distributed under the Boost Software License, Version 1.0. (See
# accompanying file LICENSE_1_0.txt or copy at
# http://www.boost.org/LICENSE_1_0.txt)
#
# This work is a reimplementation along the design and ideas
# of William E. Kempf.

subproject libs/thread/build ;

import ./threads ;

# pthreads is compiled on all platforms when available
if [ threads::is-pthread-available ] {
	
	template pthread_base
		: ## sources ##
		  [ threads::cpp_source ../src/pthread :
		    thread
		    mutex
		    condition
		    exceptions
		    xtime 
		  ]
		: ## requirements ##
		  threads::lib-pthread
		  <sysinclude>$(BOOST_ROOT)
		  <threading>multi
		  <define>BOOST_THREAD_POSIX
		  common-variant-tag
		  <borland><*><cxxflags>-w-8004
		  <borland><*><cxxflags>-w-8057
		;

	lib boost_thread_pthread
		: <template>pthread_base
		: ## requirements ##	
	  	  <define>BOOST_THREAD_BUILD_LIB=1
		;

	dll boost_thread_pthread
		: <template>pthread_base
		: ## requirements ##
          	  <runtime-link>dynamic
	  	  <define>BOOST_THREAD_BUILD_DLL=1
		;

	stage bin-stage
    		: <dll>boost_thread_pthread
      		  <lib>boost_thread_pthread
		;

	install thread_pthread lib
    		: <dll>boost_thread_pthread
      		  <lib>boost_thread_pthread
   		;

	# the next is true on platforms where pthreads is native threading lib
	if [ threads::is-native-on-build-os pthread ] {
	
		lib boost_thread
			: <template>pthread_base
			: ## requirements ##	
	  	  	  <define>BOOST_THREAD_BUILD_LIB=1
			;

		dll boost_thread
			: <template>pthread_base
			: ## requirements ##
          	  	  <runtime-link>dynamic
	  	  	  <define>BOOST_THREAD_BUILD_DLL=1
			;
	}
}

if [ threads::is-native-on-build-os win32 ] {

	template win32_base
		: ## sources ##
		  [ threads::cpp_source ../src/win32 :
		    thread
		    exceptions
		    xtime 
		  ]
		: ## requirements ##
		  <sysinclude>$(BOOST_ROOT)
		  <threading>multi
		  common-variant-tag
		  <borland><*><cxxflags>-w-8004
		  <borland><*><cxxflags>-w-8057
		;

	lib boost_thread
		: <template>win32_base
		: ## requirements ##	
  	  	  <define>BOOST_THREAD_BUILD_LIB=1
		;

	dll boost_thread
		: <template>win32_base
		: ## requirements ##
       	  	  <runtime-link>dynamic
  	  	  <define>BOOST_THREAD_BUILD_DLL=1
		;
}

stage bin-stage
	: <dll>boost_thread
      	  <lib>boost_thread
	;

install thread lib
	: <dll>boost_thread
  	  <lib>boost_thread
	;
