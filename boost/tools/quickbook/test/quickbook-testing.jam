#
#   Copyright (c) 2005 Jo√£o Abecasis
#
#   Distributed under the Boost Software License, Version 1.0. (See
#   accompanying file LICENSE_1_0.txt or copy at
#   http://www.boost.org/LICENSE_1_0.txt)
#

import feature ;
import generators ;
import testing ;
import type ;
import toolset ;

feature.feature quickbook-testing.quickbook-command : : free dependency ;

type.register BOOSTBOOK : boostbook ;
type.register QUICKBOOK : quickbook ;

generators.register-standard quickbook-testing.quickbook-to-boostbook : QUICKBOOK : BOOSTBOOK ;

exe line-compare-tool : text_diff.cpp ;

#
#   quickbook-test - generates a test for quickbook itself. A quickbook-test is
#   actually made up of two tests:
#           $(target-name) :
#               generate boostbook from $(source) or $(target-name).qbk
#
#           $(target-name).diff :
#               compare generated boostbook to $(target-name).gold
#
rule quickbook-test ( target-name : source ? : requirements * )
{
    source ?= $(target-name).quickbook ;
    local gold-output = $(source:S=.gold) ;

    return
        [ testing.make-test boostbook
            : $(source)
            : $(requirements)
                <quickbook-testing.quickbook-command>..//quickbook
            : $(target-name).boostbook
        ]

        [ testing.make-test run-output
            : line-compare-tool
            : $(requirements)
                <testing.input-file>$(target-name).boostbook
                <testing.input-file>$(gold-output)
            : $(target-name).diff
        ]
        ;
}

toolset.flags quickbook-testing.quickbook-to-boostbook quickbook-command <quickbook-testing.quickbook-command> ;
rule quickbook-to-boostbook ( target : source : properties * )
{
    DEPENDS $(target) : [ on $(target) return $(quickbook-command) ] ;
}

actions quickbook-to-boostbook bind quickbook-command
{
    $(quickbook-command) $(>) --output-file=$(<)
}
