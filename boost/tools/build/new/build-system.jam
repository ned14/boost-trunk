#  (C) Copyright David Abrahams 2001. Permission to copy, use, modify, sell and
#  distribute this software is granted provided this copyright notice appears in
#  all copies. This software is provided "as is" without express or implied
#  warranty, and with no claim as to its suitability for any purpose.
import project ;
import sequence ;
import modules ;
import feature ;
import build-request ;

import builtin ;
import make ;

import version ;

import site-config ;
import user-config ;

if --version in [ modules.peek : ARGV ]
{
    version.print ;
    EXIT ;
}

# We always load project in "." so that 'use-project' directives has
# any chance of been seen. Otherwise, we won't be able to refer to
# subprojects using target ids.
project.load "." ;

if [ MATCH (--dump-projects) : [ modules.peek : ARGV ] ]
{
    project-root.print ;
}

build-request = [ build-request.from-command-line [ modules.peek : ARGV ] ] ;

properties = [ $(build-request).get-at 2 ] ;
# For the time being, just stick toolset to the build request. We'd need to
# find a way to select default toolset collection and a method to override
# that from command line
if $(properties) 
{    
    if ! <toolset> in $(properties:G)
    {
        properties = <toolset>gcc $(properties) ;
    }    
    expanded = [ build-request.expand $(properties) ] ;
}
else
{
    # If properties contain only <toolset>, the 'generate' method of
    # 'abstract-target' will apply its default-build clause.
    expanded = <toolset>gcc ;
}


local target-ids = [ $(build-request).get-at 1 ] ;
local targets
local clean ;

if "--clean" in [ modules.peek : ARGV ]
{
    clean = true ;
}

for local id in $(target-ids)
{
    if $(id) = clean
    {
        clean = true ;
    }
    else
    {
        local t = [ project.find-target $(id) : "." ] ;
        if ! $(t)
        {
            print.wrapped-text "error: target" $(id) "does not exist" ;
            EXIT ;
        }
        else
        {
            targets += $(t) ;
        }                
    }    
}

if ! $(targets)
{
    targets += [ project.target "." ] ; 
}

virtual-targets = ;

if $(expanded) 
{
    for local p in $(expanded)
    {
        for local t in $(targets) 
        {            
            $(t).direct-build-request [ feature.split $(p) ] ;
        }        
    }
    
    for local p in $(expanded)
    {
        for local t in $(targets)
        {            
            virtual-targets += [ $(t).generate [ feature.split $(p) ] ] ;
        }        
    }
}
else
{
    for local t in $(targets)
    {        
        virtual-targets += [ $(t).generate ] ;
    }    
}


actual-targets = ;
for t in $(virtual-targets)
{
    actual-targets += [ $(t).actualize ] ;
}
NOTFILE all ;
DEPENDS all : $(actual-targets) ;

if $(clean)
{
    UPDATE clean ;
}
else
{
    UPDATE all ;
}



