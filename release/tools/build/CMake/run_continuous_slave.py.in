#!/usr/bin/python
#
#  Build slave script.
#

import pysvn, os, time

client = pysvn.Client()

wc_path = r'@CMAKE_SOURCE_DIR@'

while True:
    svn_entry = client.info(wc_path)

    print "Wc has url %s rev %d.\nChecking for updates." % (svn_entry.url, svn_entry.revision.number)

    ds = client.diff_summarize(url_or_path1=svn_entry.url,
                               revision1=pysvn.Revision(pysvn.opt_revision_kind.number, svn_entry.revision.number),
                               url_or_path2=svn_entry.url,
                               revision2=pysvn.Revision(pysvn.opt_revision_kind.head)
                               )

    if len(ds):
        print "There are %d changesets.  Updating." % len(ds)
        client.update(wc_path)
        if os.name == 'nt':
            os.system('nmake /I slave-start test slave-finish')
        else:
            os.system('make -i slave-start test slave-finish')
    else:
        print "No updates."
        time.sleep(5)

        

