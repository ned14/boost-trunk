#!/usr/bin/python
#
#  copyright (C) 2008  troy d. straszheim  <troy@resophonic.com>
#  
#  Distributed under the Boost Software License, Version 1.0.
#  See accompanying file LICENSE_1_0.txt or copy at
#  http://www.boost.org/LICENSE_1_0.txt
#

#
#  HTTP POST the build log
#

import sys
sys.path.append("@BOOST_BUILD_SLAVE_PYTHONPATH@")
from boost_build_slave import *

s = xmlrpclib.Server(xmlrpc_url)

project_name = sys.argv[1]
library_target = sys.argv[2]
logdir = sys.argv[3]

print "\n>>>\n>>> Project " + project_name \
      + "\n>>> POST build log for " + library_target \
      + "\n>>> from log dir" + logdir \
      + "\n>>> to " + xmlrpc_url \
      + "\n>>> Server build ID: %d" % build_id \
      + "\n>>>"

p = os.path.join(logdir, "Log.marshal")
f = open(p)

while True:
    try:
        r = marshal.load(f)
        r.update({ 'build_id' : build_id,
                   'project' : project_name,
                   'upper_target' : library_target})
        pprint(r)
        s.traash.step(r)
    except EOFError, e:
        break

os.remove(p)

